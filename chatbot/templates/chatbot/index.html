{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HearMe Chatbot</title>
    <link rel="stylesheet" type="text/css" href="{% static 'chatbot/css/styles.css' %}">
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="new-chat" onclick="startNewChat()">
                <i>ğŸ—¨ï¸</i> New Chat
            </div>
            <h3>Recent Conversations</h3>
            <div id="recentConversations"></div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <img src="{% static 'chatbot/images/HearMe_Lgo.png' %}" class="logo"> HearMe 
            
                <div class="user-profile">
                    <!-- Move language controls here -->
                    <div class="language-controls">
                        <select id="languageSelect" onchange="setLanguage()">
                            <option value="english">English</option>
                            <option value="kinyarwanda">Kinyarwanda</option>
                        </select>
                        <button onclick="toggleMute()" id="muteBtn">ğŸ”Š</button>
                    </div>
            
                    <div class="profile-dropdown">
                        <button class="profile-button" onclick="toggleDropdown()">
                            <img src="{% static 'chatbot/images/user-icon.avif' %}" alt="User Icon" class="profile-icon" title="{{ username }}">
                        </button>
                        <div class="dropdown-content" id="dropdownMenu">
                            <form method="POST" action="{% url 'logout' %}">
                                {% csrf_token %}
                                <button type="submit" style="background: none; border: none; color: black; cursor: pointer; padding: 5px;">Logout</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-box" id="chatBox">
                <div class="start-ai-mess">
                    Hello <b>{{ username }}</b>ğŸ‘‹ How can I assist you today? ğŸ˜Š
                </div>
            </div>

            <div class="chat-input">
                <input type="text" id="userInput" placeholder="Ask something...">
                
                <button onclick="sendMessage()">â¤</button>
                <button onclick="startVoiceInput()">ğŸ¤</button>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chatBox");
        const recentConversations = document.getElementById("recentConversations");
        let isConversationAdded = false;
        const conversations = [];
        let selectedLanguage = "english";
        let isMuted = false;

        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return value;
            }
            return null;
        }

        function setLanguage() {
            selectedLanguage = document.getElementById("languageSelect").value;
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById("muteBtn").innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        }

        function startVoiceInput() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = selectedLanguage === 'kinyarwanda' ? 'rw-RW' : 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();
            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript;
                document.getElementById("userInput").value = speechResult;
                sendMessage();
            };
            recognition.onerror = function(event) {
                alert("Voice recognition error: " + event.error);
            };
        }

        function addToRecent(userInput) {
            if (!isConversationAdded) {
                const chatItem = document.createElement("div");
                chatItem.classList.add("recent-chat");
                chatItem.innerText = userInput;
                chatItem.onclick = () => loadConversation(conversations);
                recentConversations.prepend(chatItem);
                isConversationAdded = true;
            }
        }

        function sendMessage() {
            const userInput = document.getElementById("userInput").value;
            if (userInput.trim() === "") return;

            const initialMessage = document.querySelector(".start-ai-mess");
            if (initialMessage) initialMessage.remove();

            const userMsg = document.createElement("div");
            userMsg.classList.add("message", "user-message");
            userMsg.innerText = userInput;
            chatBox.appendChild(userMsg);

            conversations.push({ type: "user", text: userInput });
            document.getElementById("userInput").value = "";

            const typingIndicator = document.createElement("div");
            typingIndicator.classList.add("message", "ai-message");
            typingIndicator.innerText = "Typing...";
            chatBox.appendChild(typingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;

            setTimeout(() => {
                fetch('/chatbot/response/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: 'user_input=' + encodeURIComponent(userInput),
                })
                .then(response => response.json())
                .then(data => {
                    chatBox.removeChild(typingIndicator);

                    const aiMsg = document.createElement("div");
                    aiMsg.classList.add("message", "ai-message");

                    if (data.ai_response.includes("Watch here:")) {
                        const parts = data.ai_response.split("Watch here:");
                        aiMsg.innerHTML = parts[0] + `<br><iframe width="300" height="200" src="${parts[1].trim()}" frameborder="0" allowfullscreen></iframe>`;
                    } else {
                        aiMsg.innerText = data.ai_response;
                    }

                    chatBox.appendChild(aiMsg);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    // Speak the response
                    if (!isMuted) {
                        const utterance = new SpeechSynthesisUtterance(data.ai_response);
                        utterance.lang = selectedLanguage === 'kinyarwanda' ? 'rw-RW' : 'en-US';
                        const voices = window.speechSynthesis.getVoices();
                        const matchingVoice = voices.find(v => v.lang === utterance.lang);
                        if (matchingVoice) utterance.voice = matchingVoice;
                        window.speechSynthesis.speak(utterance);
                    }

                    conversations.push({ type: "ai", text: data.ai_response });
                    addToRecent(userInput);
                })
                .catch(error => {
                    chatBox.removeChild(typingIndicator);
                    const errorMsg = document.createElement("div");
                    errorMsg.classList.add("message", "ai-message");
                    errorMsg.innerText = "Sorry, something went wrong.";
                    chatBox.appendChild(errorMsg);
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            }, 500);
        }
        document.getElementById("userInput").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
});


        function loadConversation(conversation) {
            chatBox.innerHTML = "";
            conversation.forEach(msg => {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message", msg.type === "user" ? "user-message" : "ai-message");
                messageDiv.innerText = msg.text;
                chatBox.appendChild(messageDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function startNewChat() {
            chatBox.innerHTML = '<div class="start-ai-mess">Hello <b>{{ username }}</b>ğŸ‘‹ How can I assist you today? ğŸ˜Š</div>';
            isConversationAdded = false;
            conversations.length = 0;
        }

        function toggleDropdown() {
            const dropdown = document.querySelector('.profile-dropdown');
            dropdown.classList.toggle('active');
        }

        window.addEventListener('click', function (event) {
            const dropdown = document.querySelector('.profile-dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Preload voices (especially for rw-RW)
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    </script>
</body>
</html>
